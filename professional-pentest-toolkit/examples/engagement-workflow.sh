#!/bin/bash
#
# Exemple de workflow complet pour un engagement de pentest web
#
# IMPORTANT: A adapter selon votre engagement specifique
#

set -e

ENGAGEMENT_NAME="Client-2024-001"
CLIENT_NAME="ACME Corporation"
TARGET_DOMAIN="app.example.com"

echo "=========================================="
echo "Workflow Pentest - ${ENGAGEMENT_NAME}"
echo "=========================================="
echo ""

# 1. INITIALISATION
echo "[1/7] Initialisation de l'engagement..."

# Demarrer l'engagement logger
python3 ../utilities/engagement-logger.py --start "${ENGAGEMENT_NAME}" \
    --client "${CLIENT_NAME}" \
    --scope "Web application at ${TARGET_DOMAIN}"

# Charger le scope
python3 ../utilities/scope-manager.py --load scope-example.txt \
    --metadata --engagement "${ENGAGEMENT_NAME}" --client "${CLIENT_NAME}"

# Initialiser le rapport
python3 ../reporting/report-generator.py --init "${ENGAGEMENT_NAME}" \
    --client "${CLIENT_NAME}" \
    --tester "Votre Nom" \
    --scope "Application web ${TARGET_DOMAIN}"

echo "[+] Engagement initialise"
echo ""

# 2. RECONNAISSANCE
echo "[2/7] Phase de reconnaissance..."

# Verifier que la cible est dans le scope
python3 ../utilities/scope-manager.py --check "${TARGET_DOMAIN}" || {
    echo "[!] ERREUR: Cible hors scope!"
    exit 1
}

# Enumeration de sous-domaines
echo "  [*] Enumeration de sous-domaines..."
subfinder -d "${TARGET_DOMAIN}" -silent -o subdomains.txt 2>/dev/null || true

# Logger l'action
python3 ../utilities/engagement-logger.py --log "Subdomain enumeration completed" \
    --category reconnaissance \
    --target "${TARGET_DOMAIN}" \
    --details "Subfinder found $(wc -l < subdomains.txt 2>/dev/null || echo 0) subdomains"

echo "[+] Reconnaissance terminee"
echo ""

# 3. SCANNING
echo "[3/7] Phase de scanning..."

# Verification des hotes actifs
echo "  [*] Verification des hotes actifs..."
if [ -f "subdomains.txt" ]; then
    httpx -l subdomains.txt -silent -o live-hosts.txt 2>/dev/null || true
fi

# Scan Nuclei
echo "  [*] Scan de vulnerabilites avec Nuclei..."
if [ -f "live-hosts.txt" ]; then
    nuclei -l live-hosts.txt -severity critical,high,medium \
        -silent -o nuclei-findings.txt 2>/dev/null || true
fi

python3 ../utilities/engagement-logger.py --log "Vulnerability scanning completed" \
    --category scanning \
    --target "${TARGET_DOMAIN}" \
    --details "Nuclei scan completed"

echo "[+] Scanning termine"
echo ""

# 4. ENUMERATION
echo "[4/7] Phase d'enumeration..."

# Content discovery
echo "  [*] Content discovery..."
# ffuf -u "https://${TARGET_DOMAIN}/FUZZ" -w /path/to/wordlist -mc 200,301,302 -o ffuf-results.txt

python3 ../utilities/engagement-logger.py --log "Content discovery completed" \
    --category enumeration \
    --target "${TARGET_DOMAIN}"

echo "[+] Enumeration terminee"
echo ""

# 5. TESTS MANUELS
echo "[5/7] Phase de tests manuels..."
echo "  [!] Cette phase necessite une intervention manuelle"
echo "  [*] Utilisez Burp Suite Pro pour:"
echo "      - Tests d'injection (SQL, XSS, etc.)"
echo "      - Tests d'authentification"
echo "      - Tests de controle d'acces"
echo "      - Tests de logique metier"
echo ""
echo "  [*] Pour logger vos findings:"
echo "      python3 ../reporting/report-generator.py --add-finding \\"
echo "        --title \"Titre de la vulnerabilite\" \\"
echo "        --severity critical|high|medium|low \\"
echo "        --description \"Description\" \\"
echo "        --remediation \"Recommandations\""
echo ""
read -p "  Appuyez sur ENTREE une fois les tests manuels termines..."

python3 ../utilities/engagement-logger.py --log "Manual testing phase completed" \
    --category exploitation \
    --target "${TARGET_DOMAIN}"

echo "[+] Tests manuels termines"
echo ""

# 6. REPORTING
echo "[6/7] Generation du rapport..."

# Generer le rapport d'activite
python3 ../utilities/engagement-logger.py --report --engagement "${ENGAGEMENT_NAME}"

# Generer le rapport de vulnerabilites
python3 ../reporting/report-generator.py --generate --format both

echo "[+] Rapports generes"
echo ""

# 7. CLEANUP
echo "[7/7] Nettoyage..."

# Terminer l'engagement
python3 ../utilities/engagement-logger.py --end

echo "[+] Engagement termine"
echo ""

echo "=========================================="
echo "Workflow Complete!"
echo "=========================================="
echo ""
echo "Fichiers generes:"
echo "  - reports/${ENGAGEMENT_NAME}/report.md"
echo "  - reports/${ENGAGEMENT_NAME}/report.html"
echo "  - engagements/${ENGAGEMENT_NAME}/activity-report.md"
echo "  - engagements/${ENGAGEMENT_NAME}/timeline.txt"
echo ""
echo "Prochaines etapes:"
echo "  1. Reviser les rapports"
echo "  2. Nettoyer les artefacts du test"
echo "  3. Presenter les resultats au client"
echo "  4. Archiver les donnees de maniere securisee"
echo ""
