#!/bin/bash
#
# Installation d'outils professionnels de pentest
# Usage: sudo bash install-tools.sh
#
# IMPORTANT: A utiliser uniquement dans un environnement autorise
#

set -e

echo "=================================================="
echo "Installation d'Outils Professionnels de Pentest"
echo "=================================================="
echo ""

# Verification root
if [ "$EUID" -ne 0 ]; then
    echo "[!] Ce script doit etre execute en tant que root"
    echo "    Usage: sudo bash install-tools.sh"
    exit 1
fi

echo "[*] Mise a jour du systeme..."
apt update && apt upgrade -y

echo ""
echo "[*] Installation des dependances de base..."
apt install -y \
    git curl wget \
    python3 python3-pip python3-venv \
    build-essential \
    golang-go \
    ruby ruby-dev \
    nodejs npm \
    jq unzip

echo ""
echo "=== OUTILS DE RECONNAISSANCE ==="
echo ""

# Nmap
echo "[+] Installation de Nmap..."
apt install -y nmap

# Masscan
echo "[+] Installation de Masscan..."
apt install -y masscan

# DNSRecon
echo "[+] Installation de DNSRecon..."
pip3 install dnsrecon

# Subfinder
echo "[+] Installation de Subfinder..."
go install -v github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest

# Httpx
echo "[+] Installation de Httpx..."
go install -v github.com/projectdiscovery/httpx/cmd/httpx@latest

# Nuclei
echo "[+] Installation de Nuclei..."
go install -v github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest

# Nuclei templates
echo "[+] Mise a jour des templates Nuclei..."
nuclei -update-templates || true

echo ""
echo "=== OUTILS WEB ==="
echo ""

# OWASP ZAP
echo "[+] Installation de OWASP ZAP..."
apt install -y zaproxy || {
    echo "[!] ZAP non disponible via apt, installation manuelle requise"
    echo "    Voir: https://www.zaproxy.org/download/"
}

# SQLMap
echo "[+] Installation de SQLMap..."
apt install -y sqlmap

# Ffuf
echo "[+] Installation de Ffuf..."
go install github.com/ffuf/ffuf/v2@latest

# Gobuster
echo "[+] Installation de Gobuster..."
go install github.com/OJ/gobuster/v3@latest

# Nikto
echo "[+] Installation de Nikto..."
apt install -y nikto

# Wfuzz
echo "[+] Installation de Wfuzz..."
pip3 install wfuzz

echo ""
echo "=== OUTILS POST-EXPLOITATION ==="
echo ""

# Impacket
echo "[+] Installation de Impacket..."
pip3 install impacket

# BloodHound
echo "[+] Installation de BloodHound..."
apt install -y bloodhound || {
    echo "[!] BloodHound non disponible via apt"
    echo "    Installation manuelle: https://github.com/BloodHoundAD/BloodHound"
}

# LinPEAS / WinPEAS
echo "[+] Telechargement de PEASS-ng..."
mkdir -p /opt/peass
cd /opt/peass
wget -q https://github.com/carlospolop/PEASS-ng/releases/latest/download/linpeas.sh
wget -q https://github.com/carlospolop/PEASS-ng/releases/latest/download/winPEASx64.exe
chmod +x linpeas.sh
cd - > /dev/null

echo ""
echo "=== WORDLISTS ==="
echo ""

# SecLists
echo "[+] Installation de SecLists..."
if [ ! -d "/opt/SecLists" ]; then
    git clone https://github.com/danielmiessler/SecLists.git /opt/SecLists
else
    echo "    SecLists deja installe"
fi

echo ""
echo "=== CONFIGURATION DE L'ENVIRONNEMENT ==="
echo ""

# Ajouter Go binaries au PATH
echo "[+] Configuration du PATH..."
if ! grep -q "go/bin" ~/.bashrc 2>/dev/null; then
    echo 'export PATH=$PATH:/usr/local/go/bin:$(go env GOPATH)/bin' >> ~/.bashrc
    echo "    PATH mis a jour dans ~/.bashrc"
fi

# Aliases utiles
echo "[+] Creation d'aliases..."
cat >> ~/.bash_aliases << 'EOF'
# Pentest aliases
alias nmap-quick='nmap -T4 -F'
alias nmap-full='nmap -T4 -p- -A'
alias nmap-vuln='nmap --script vuln'
alias httpx-probe='httpx -silent -status-code -title -tech-detect'
alias nuclei-scan='nuclei -silent -severity critical,high,medium'
EOF

echo ""
echo "=== VERIFICATION DES INSTALLATIONS ==="
echo ""

check_tool() {
    if command -v $1 &> /dev/null; then
        echo "[+] $1: $(command -v $1)"
    else
        echo "[-] $1: NON INSTALLE"
    fi
}

check_tool nmap
check_tool masscan
check_tool subfinder
check_tool httpx
check_tool nuclei
check_tool sqlmap
check_tool ffuf
check_tool gobuster
check_tool nikto

echo ""
echo "=== OUTILS GO (dans GOPATH) ==="
GO_TOOLS=(subfinder httpx nuclei ffuf gobuster)
for tool in "${GO_TOOLS[@]}"; do
    if [ -f "$(go env GOPATH)/bin/$tool" ]; then
        echo "[+] $tool: $(go env GOPATH)/bin/$tool"
    else
        echo "[-] $tool: NON TROUVE"
    fi
done

echo ""
echo "=================================================="
echo "Installation terminee!"
echo "=================================================="
echo ""
echo "Prochaines etapes:"
echo "  1. Recharger le shell: source ~/.bashrc"
echo "  2. Verifier les outils: nmap --version, nuclei -version, etc."
echo "  3. Installer Burp Suite Pro (commercial): https://portswigger.net/"
echo "  4. Installer Metasploit: curl https://raw.githubusercontent.com/rapid7/metasploit-omnibus/master/config/templates/metasploit-framework-wrappers/msfupdate.erb > msfinstall && chmod 755 msfinstall && ./msfinstall"
echo ""
echo "Wordlists disponibles dans: /opt/SecLists"
echo "Scripts PEASS disponibles dans: /opt/peass"
echo ""
echo "IMPORTANT: Ces outils sont pour usage autorise uniquement!"
echo ""
