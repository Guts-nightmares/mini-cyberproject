# Lab Diagnostic Script - Windows
#
# Purpose: Collect system information for lab testing
# Usage: powershell -ExecutionPolicy Bypass .\lab-diagnostic.ps1
#
# AUTHORIZATION: Use only on your own lab machines

$ErrorActionPreference = "SilentlyContinue"
$OutputFile = "$env:TEMP\lab-diagnostic-$(Get-Date -Format 'yyyyMMdd-HHmmss').txt"

Write-Host "=========================================="
Write-Host "Lab Diagnostic Script"
Write-Host "Started: $(Get-Date)"
Write-Host "=========================================="
Write-Host ""

$Report = @"
==========================================
SYSTEM DIAGNOSTIC REPORT
Generated: $(Get-Date)
==========================================

"@

# Basic System Information
$Report += @"
=== BASIC INFORMATION ===
Computer Name: $env:COMPUTERNAME
Username: $env:USERNAME
Domain: $env:USERDOMAIN

"@

# Operating System
$OS = Get-CimInstance Win32_OperatingSystem
$Report += @"
=== OPERATING SYSTEM ===
OS Name: $($OS.Caption)
Version: $($OS.Version)
Architecture: $($OS.OSArchitecture)
Install Date: $($OS.InstallDate)
Last Boot: $($OS.LastBootUpTime)

"@

# Network Configuration
$Report += "=== NETWORK CONFIGURATION ===`n"
$Report += "--- IP Addresses ---`n"
Get-NetIPAddress | Where-Object {$_.AddressFamily -eq 'IPv4'} | ForEach-Object {
    $Report += "Interface: $($_.InterfaceAlias) - IP: $($_.IPAddress)`n"
}
$Report += "`n"

$Report += "--- DNS Servers ---`n"
Get-DnsClientServerAddress | Where-Object {$_.AddressFamily -eq 2} | ForEach-Object {
    $Report += "Interface: $($_.InterfaceAlias) - DNS: $($_.ServerAddresses -join ', ')`n"
}
$Report += "`n"

# Security Checks
$Report += "=== SECURITY CHECKS ===`n"

$Report += "--- Firewall Status ---`n"
try {
    $FirewallProfiles = Get-NetFirewallProfile
    foreach ($Profile in $FirewallProfiles) {
        $Report += "$($Profile.Name): $($Profile.Enabled)`n"
    }
} catch {
    $Report += "Unable to check firewall status`n"
}
$Report += "`n"

$Report += "--- Windows Defender Status ---`n"
try {
    $DefenderStatus = Get-MpComputerStatus
    $Report += "AntivirusEnabled: $($DefenderStatus.AntivirusEnabled)`n"
    $Report += "RealTimeProtectionEnabled: $($DefenderStatus.RealTimeProtectionEnabled)`n"
    $Report += "AntispywareEnabled: $($DefenderStatus.AntispywareEnabled)`n"
} catch {
    $Report += "Unable to check Windows Defender status`n"
}
$Report += "`n"

$Report += "--- User Account Control (UAC) ---`n"
$UACLevel = (Get-ItemProperty HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System).ConsentPromptBehaviorAdmin
$Report += "UAC Level: $UACLevel (0=Disabled, 2=Default, 5=Always notify)`n"
$Report += "`n"

# USB Devices
$Report += "=== USB DEVICES ===`n"
Get-PnpDevice | Where-Object {$_.Class -eq 'USB'} | Select-Object -First 10 | ForEach-Object {
    $Report += "$($_.FriendlyName) - Status: $($_.Status)`n"
}
$Report += "`n"

# Running Processes (Top 10 by CPU)
$Report += "=== RUNNING PROCESSES (Top 10 by CPU) ===`n"
Get-Process | Sort-Object CPU -Descending | Select-Object -First 10 | ForEach-Object {
    $Report += "$($_.ProcessName) - CPU: $($_.CPU) - Memory: $([math]::Round($_.WS/1MB, 2)) MB`n"
}
$Report += "`n"

# Installed Software (sample)
$Report += "=== INSTALLED SOFTWARE (Sample) ===`n"
Get-ItemProperty HKLM:\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\Uninstall\* |
    Where-Object {$_.DisplayName -ne $null} |
    Select-Object -First 10 DisplayName, DisplayVersion |
    ForEach-Object {
        $Report += "$($_.DisplayName) - Version: $($_.DisplayVersion)`n"
    }
$Report += "`n"

# Listening Ports
$Report += "=== LISTENING PORTS ===`n"
Get-NetTCPConnection | Where-Object {$_.State -eq 'Listen'} | Select-Object -First 15 | ForEach-Object {
    $Report += "Port: $($_.LocalPort) - Process: $(Get-Process -Id $_.OwningProcess -ErrorAction SilentlyContinue | Select-Object -ExpandProperty ProcessName)`n"
}
$Report += "`n"

# Screen Lock Settings
$Report += "=== SCREEN LOCK SETTINGS ===`n"
try {
    $ScreenSaverTimeout = (Get-ItemProperty 'HKCU:\Control Panel\Desktop').ScreenSaveTimeOut
    $Report += "Screen saver timeout: $($ScreenSaverTimeout) seconds`n"

    $ScreenSaverActive = (Get-ItemProperty 'HKCU:\Control Panel\Desktop').ScreenSaveActive
    $Report += "Screen saver active: $ScreenSaverActive`n"
} catch {
    $Report += "Unable to check screen lock settings`n"
}
$Report += "`n"

# Disk Information
$Report += "=== DISK USAGE ===`n"
Get-PSDrive | Where-Object {$_.Provider.Name -eq 'FileSystem'} | ForEach-Object {
    $UsedGB = [math]::Round($_.Used / 1GB, 2)
    $FreeGB = [math]::Round($_.Free / 1GB, 2)
    $Report += "Drive $($_.Name): Used: $UsedGB GB, Free: $FreeGB GB`n"
}
$Report += "`n"

$Report += @"
==========================================
Diagnostic Complete
==========================================
"@

# Save report
$Report | Out-File -FilePath $OutputFile -Encoding UTF8

# Display report
Write-Host $Report

Write-Host ""
Write-Host "[+] Report saved to: $OutputFile" -ForegroundColor Green
Write-Host "[*] Review the report for security findings" -ForegroundColor Yellow
Write-Host ""

# Copy to clipboard
$Report | Set-Clipboard
Write-Host "[+] Report copied to clipboard" -ForegroundColor Green
