#!/bin/bash
#
# Lab Diagnostic Script - Linux/macOS
#
# Purpose: Collect system information for lab testing
# Usage: bash lab-diagnostic.sh
#
# AUTHORIZATION: Use only on your own lab machines
#

set -e

OUTPUT_FILE="/tmp/lab-diagnostic-$(date +%Y%m%d-%H%M%S).txt"

echo "=========================================="
echo "Lab Diagnostic Script"
echo "Started: $(date)"
echo "=========================================="
echo ""

{
    echo "=========================================="
    echo "SYSTEM DIAGNOSTIC REPORT"
    echo "Generated: $(date)"
    echo "=========================================="
    echo ""

    # Basic System Information
    echo "=== BASIC INFORMATION ==="
    echo "Hostname: $(hostname)"
    echo "User: $(whoami)"
    echo "User ID: $(id)"
    echo ""

    # Operating System
    echo "=== OPERATING SYSTEM ==="
    if [ -f /etc/os-release ]; then
        cat /etc/os-release
    elif [ "$(uname)" == "Darwin" ]; then
        echo "macOS Version: $(sw_vers -productVersion)"
        echo "Build: $(sw_vers -buildVersion)"
    else
        uname -a
    fi
    echo ""

    # Network Configuration
    echo "=== NETWORK CONFIGURATION ==="
    echo "--- IP Addresses ---"
    if command -v ip &> /dev/null; then
        ip addr show | grep -E "inet |ether "
    elif command -v ifconfig &> /dev/null; then
        ifconfig | grep -E "inet |ether "
    fi
    echo ""

    echo "--- Routing Table ---"
    if command -v ip &> /dev/null; then
        ip route show
    elif command -v netstat &> /dev/null; then
        netstat -rn
    fi
    echo ""

    echo "--- DNS Configuration ---"
    if [ -f /etc/resolv.conf ]; then
        cat /etc/resolv.conf
    fi
    echo ""

    # Security Checks
    echo "=== SECURITY CHECKS ==="

    echo "--- Firewall Status ---"
    if command -v ufw &> /dev/null; then
        sudo ufw status 2>/dev/null || echo "UFW status check requires sudo"
    elif command -v firewall-cmd &> /dev/null; then
        sudo firewall-cmd --state 2>/dev/null || echo "Firewall check requires sudo"
    elif [ "$(uname)" == "Darwin" ]; then
        sudo /usr/libexec/ApplicationFirewall/socketfilterfw --getglobalstate 2>/dev/null || echo "Firewall check requires sudo"
    fi
    echo ""

    echo "--- Listening Ports ---"
    if command -v ss &> /dev/null; then
        ss -tuln 2>/dev/null | head -20
    elif command -v netstat &> /dev/null; then
        netstat -tuln 2>/dev/null | head -20
    fi
    echo ""

    echo "--- USB Devices ---"
    if command -v lsusb &> /dev/null; then
        lsusb 2>/dev/null
    elif [ "$(uname)" == "Darwin" ]; then
        system_profiler SPUSBDataType 2>/dev/null | grep -E "Product ID:|Vendor ID:|Serial Number:" | head -20
    fi
    echo ""

    # Running Processes
    echo "=== RUNNING PROCESSES (Top 10 by CPU) ==="
    ps aux --sort=-%cpu 2>/dev/null | head -11 || ps aux 2>/dev/null | head -11
    echo ""

    # Disk Usage
    echo "=== DISK USAGE ==="
    df -h 2>/dev/null || df
    echo ""

    # System Uptime
    echo "=== SYSTEM UPTIME ==="
    uptime
    echo ""

    # Installed Security Tools (common ones)
    echo "=== SECURITY TOOLS DETECTED ==="
    for tool in nmap tcpdump wireshark metasploit burpsuite; do
        if command -v $tool &> /dev/null; then
            echo "- $tool: $(command -v $tool)"
        fi
    done
    echo ""

    # Auto-lock Status (if applicable)
    echo "=== SCREEN LOCK SETTINGS ==="
    if [ "$(uname)" == "Darwin" ]; then
        echo "Screen saver timeout: $(defaults read com.apple.screensaver idleTime 2>/dev/null || echo 'Not set')"
    elif command -v gsettings &> /dev/null; then
        echo "Idle delay: $(gsettings get org.gnome.desktop.session idle-delay 2>/dev/null || echo 'Not configured')"
        echo "Lock enabled: $(gsettings get org.gnome.desktop.screensaver lock-enabled 2>/dev/null || echo 'Not configured')"
    fi
    echo ""

    echo "=========================================="
    echo "Diagnostic Complete"
    echo "=========================================="

} > "$OUTPUT_FILE"

# Display results
cat "$OUTPUT_FILE"

echo ""
echo "[+] Report saved to: $OUTPUT_FILE"
echo "[*] Review the report for security findings"
echo ""

# Optional: Copy to clipboard if available
if command -v pbcopy &> /dev/null; then
    cat "$OUTPUT_FILE" | pbcopy
    echo "[+] Report copied to clipboard (macOS)"
elif command -v xclip &> /dev/null; then
    cat "$OUTPUT_FILE" | xclip -selection clipboard
    echo "[+] Report copied to clipboard (Linux)"
fi
