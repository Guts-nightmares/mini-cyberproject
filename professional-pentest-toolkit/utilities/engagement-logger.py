#!/usr/bin/env python3
"""
Engagement Logger - Logging detaille pour engagements de pentest

Ce script permet de:
- Logger toutes les actions pendant un engagement
- Generer des rapports d'activite pour conformite
- Tracer la timeline complete d'un test
- Fournir des preuves d'actions pour les clients

Usage:
    python engagement-logger.py --start "Client-2024-001"
    python engagement-logger.py --log "Nmap scan on 192.168.1.0/24"
    python engagement-logger.py --report
"""

import argparse
import json
import sys
from datetime import datetime
from pathlib import Path
from typing import Dict, List, Optional


class EngagementLogger:
    """Logger professionnel pour engagements de pentest"""

    def __init__(self, engagement_dir: str = "engagements"):
        self.base_dir = Path(engagement_dir)
        self.base_dir.mkdir(exist_ok=True)
        self.current_engagement: Optional[str] = None
        self.load_current_engagement()

    def load_current_engagement(self) -> None:
        """Charge l'engagement actif"""
        state_file = self.base_dir / "current.txt"
        if state_file.exists():
            self.current_engagement = state_file.read_text().strip()

    def start_engagement(self, name: str, client: str = "", scope: str = "") -> None:
        """Demarre un nouvel engagement"""
        timestamp = datetime.now()
        engagement_id = name

        engagement_dir = self.base_dir / engagement_id
        engagement_dir.mkdir(exist_ok=True)

        metadata = {
            "engagement_id": engagement_id,
            "client_name": client,
            "scope_description": scope,
            "start_time": timestamp.isoformat(),
            "end_time": None,
            "tester": self._get_tester_name(),
            "status": "active"
        }

        metadata_file = engagement_dir / "metadata.json"
        with open(metadata_file, 'w') as f:
            json.dump(metadata, f, indent=2)

        log_file = engagement_dir / "activity.log"
        with open(log_file, 'w') as f:
            f.write(f"=== ENGAGEMENT LOG: {engagement_id} ===\n")
            f.write(f"Started: {timestamp.isoformat()}\n")
            f.write(f"Client: {client}\n")
            f.write(f"Scope: {scope}\n")
            f.write("="*60 + "\n\n")

        self.current_engagement = engagement_id
        state_file = self.base_dir / "current.txt"
        state_file.write_text(engagement_id)

        print(f"[+] Engagement '{engagement_id}' demarre")
        print(f"[+] Repertoire: {engagement_dir}")

    def _get_tester_name(self) -> str:
        """Recupere le nom du testeur"""
        import getpass
        import socket
        return f"{getpass.getuser()}@{socket.gethostname()}"

    def log_action(self, action: str, category: str = "general",
                   target: str = "", details: str = "", severity: str = "info") -> None:
        """Log une action pendant l'engagement"""
        if not self.current_engagement:
            print("[!] Aucun engagement actif. Utilisez --start d'abord")
            sys.exit(1)

        timestamp = datetime.now()
        engagement_dir = self.base_dir / self.current_engagement

        log_entry = {
            "timestamp": timestamp.isoformat(),
            "category": category,
            "action": action,
            "target": target,
            "details": details,
            "severity": severity,
            "tester": self._get_tester_name()
        }

        # Log JSON structure
        json_log = engagement_dir / "activity.json"
        if json_log.exists():
            with open(json_log, 'r') as f:
                logs = json.load(f)
        else:
            logs = []

        logs.append(log_entry)

        with open(json_log, 'w') as f:
            json.dump(logs, f, indent=2)

        # Log texte lisible
        text_log = engagement_dir / "activity.log"
        with open(text_log, 'a') as f:
            f.write(f"[{timestamp.strftime('%Y-%m-%d %H:%M:%S')}] ")
            f.write(f"[{category.upper()}] ")
            if target:
                f.write(f"[Target: {target}] ")
            f.write(f"{action}\n")
            if details:
                f.write(f"  Details: {details}\n")
            f.write("\n")

        print(f"[+] Action loggee: {action}")

    def end_engagement(self) -> None:
        """Termine l'engagement actif"""
        if not self.current_engagement:
            print("[!] Aucun engagement actif")
            sys.exit(1)

        engagement_dir = self.base_dir / self.current_engagement
        metadata_file = engagement_dir / "metadata.json"

        with open(metadata_file, 'r') as f:
            metadata = json.load(f)

        metadata["end_time"] = datetime.now().isoformat()
        metadata["status"] = "completed"

        with open(metadata_file, 'w') as f:
            json.dump(metadata, f, indent=2)

        text_log = engagement_dir / "activity.log"
        with open(text_log, 'a') as f:
            f.write("\n" + "="*60 + "\n")
            f.write(f"Engagement termine: {datetime.now().isoformat()}\n")
            f.write("="*60 + "\n")

        print(f"[+] Engagement '{self.current_engagement}' termine")

        state_file = self.base_dir / "current.txt"
        state_file.unlink(missing_ok=True)
        self.current_engagement = None

    def generate_report(self, engagement_id: str = None) -> None:
        """Genere un rapport d'activite"""
        if engagement_id:
            target_engagement = engagement_id
        elif self.current_engagement:
            target_engagement = self.current_engagement
        else:
            print("[!] Specifiez un engagement avec --engagement")
            sys.exit(1)

        engagement_dir = self.base_dir / target_engagement

        if not engagement_dir.exists():
            print(f"[!] Engagement '{target_engagement}' introuvable")
            sys.exit(1)

        # Charger metadata
        metadata_file = engagement_dir / "metadata.json"
        with open(metadata_file, 'r') as f:
            metadata = json.load(f)

        # Charger logs
        json_log = engagement_dir / "activity.json"
        if json_log.exists():
            with open(json_log, 'r') as f:
                logs = json.load(f)
        else:
            logs = []

        # Generer rapport Markdown
        report_file = engagement_dir / "activity-report.md"

        with open(report_file, 'w') as f:
            f.write(f"# Rapport d'Activite - {metadata['engagement_id']}\n\n")

            f.write("## Informations Generales\n\n")
            f.write(f"- **Engagement ID:** {metadata['engagement_id']}\n")
            f.write(f"- **Client:** {metadata.get('client_name', 'N/A')}\n")
            f.write(f"- **Testeur:** {metadata.get('tester', 'N/A')}\n")
            f.write(f"- **Debut:** {metadata['start_time']}\n")
            if metadata.get('end_time'):
                f.write(f"- **Fin:** {metadata['end_time']}\n")
            f.write(f"- **Statut:** {metadata['status']}\n\n")

            if metadata.get('scope_description'):
                f.write(f"**Scope:** {metadata['scope_description']}\n\n")

            f.write("## Statistiques\n\n")
            f.write(f"- **Total d'actions:** {len(logs)}\n")

            categories = {}
            for log in logs:
                cat = log.get('category', 'general')
                categories[cat] = categories.get(cat, 0) + 1

            f.write("\n### Par Categorie\n\n")
            for cat, count in sorted(categories.items()):
                f.write(f"- **{cat.capitalize()}:** {count}\n")

            f.write("\n## Timeline Complete\n\n")
            for log in logs:
                ts = datetime.fromisoformat(log['timestamp'])
                f.write(f"### {ts.strftime('%Y-%m-%d %H:%M:%S')}\n\n")
                f.write(f"**Categorie:** {log['category']}\n\n")
                f.write(f"**Action:** {log['action']}\n\n")
                if log.get('target'):
                    f.write(f"**Cible:** {log['target']}\n\n")
                if log.get('details'):
                    f.write(f"**Details:**\n```\n{log['details']}\n```\n\n")
                f.write("---\n\n")

            f.write("## Conclusion\n\n")
            f.write("Ce rapport documente toutes les actions effectuees pendant l'engagement ")
            f.write("a des fins de conformite et de tracabilite.\n")

        print(f"[+] Rapport genere: {report_file}")
        print(f"[+] Total d'actions: {len(logs)}")

        # Generer aussi un rapport texte simple
        simple_report = engagement_dir / "timeline.txt"
        with open(simple_report, 'w') as f:
            f.write(f"TIMELINE - {metadata['engagement_id']}\n")
            f.write("="*80 + "\n\n")
            for log in logs:
                ts = datetime.fromisoformat(log['timestamp'])
                f.write(f"{ts.strftime('%Y-%m-%d %H:%M:%S')} | ")
                f.write(f"{log['category'].upper():12} | ")
                if log.get('target'):
                    f.write(f"{log['target']:20} | ")
                f.write(f"{log['action']}\n")

        print(f"[+] Timeline generee: {simple_report}")

    def list_engagements(self) -> None:
        """Liste tous les engagements"""
        engagements = []

        for eng_dir in self.base_dir.iterdir():
            if eng_dir.is_dir():
                metadata_file = eng_dir / "metadata.json"
                if metadata_file.exists():
                    with open(metadata_file, 'r') as f:
                        metadata = json.load(f)
                    engagements.append(metadata)

        if not engagements:
            print("[*] Aucun engagement trouve")
            return

        print("\n=== ENGAGEMENTS ===\n")
        for eng in sorted(engagements, key=lambda x: x['start_time'], reverse=True):
            print(f"ID: {eng['engagement_id']}")
            print(f"  Client: {eng.get('client_name', 'N/A')}")
            print(f"  Debut: {eng['start_time']}")
            print(f"  Statut: {eng['status']}")
            if eng.get('end_time'):
                print(f"  Fin: {eng['end_time']}")
            print()

def main():
    parser = argparse.ArgumentParser(
        description="Logger professionnel pour engagements de pentest",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Exemples:
  # Demarrer un engagement
  python engagement-logger.py --start "Client-2024-001" --client "ACME Corp"

  # Logger une action
  python engagement-logger.py --log "Nmap scan" --target "192.168.1.0/24" --category reconnaissance

  # Logger avec details
  python engagement-logger.py --log "SQL injection found" --target "app.example.com" \\
    --category exploitation --details "Union-based SQLi in id parameter" --severity high

  # Generer un rapport
  python engagement-logger.py --report

  # Terminer l'engagement
  python engagement-logger.py --end

  # Lister tous les engagements
  python engagement-logger.py --list

Categories courantes:
  - reconnaissance
  - scanning
  - enumeration
  - exploitation
  - post-exploitation
  - privilege-escalation
  - lateral-movement
  - persistence
  - cleanup
        """
    )

    parser.add_argument('--start', metavar='NAME',
                       help='Demarrer un nouvel engagement')
    parser.add_argument('--client', metavar='NAME',
                       help='Nom du client (avec --start)')
    parser.add_argument('--scope', metavar='DESC',
                       help='Description du scope (avec --start)')
    parser.add_argument('--log', metavar='ACTION',
                       help='Logger une action')
    parser.add_argument('--category', default='general',
                       help='Categorie de l\'action (default: general)')
    parser.add_argument('--target', default='',
                       help='Cible de l\'action')
    parser.add_argument('--details', default='',
                       help='Details supplementaires')
    parser.add_argument('--severity', default='info',
                       choices=['info', 'low', 'medium', 'high', 'critical'],
                       help='Severite (default: info)')
    parser.add_argument('--end', action='store_true',
                       help='Terminer l\'engagement actif')
    parser.add_argument('--report', action='store_true',
                       help='Generer un rapport d\'activite')
    parser.add_argument('--engagement', metavar='ID',
                       help='ID d\'engagement (pour --report)')
    parser.add_argument('--list', action='store_true',
                       help='Lister tous les engagements')
    parser.add_argument('--dir', default='engagements',
                       help='Repertoire des engagements (default: engagements)')

    args = parser.parse_args()

    if len(sys.argv) == 1:
        parser.print_help()
        sys.exit(0)

    logger = EngagementLogger(args.dir)

    if args.start:
        logger.start_engagement(
            name=args.start,
            client=args.client or "",
            scope=args.scope or ""
        )

    if args.log:
        logger.log_action(
            action=args.log,
            category=args.category,
            target=args.target,
            details=args.details,
            severity=args.severity
        )

    if args.end:
        logger.end_engagement()

    if args.report:
        logger.generate_report(args.engagement)

    if args.list:
        logger.list_engagements()


if __name__ == "__main__":
    main()
